<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Interna | Grupo Amalgama</title>
    <!-- Inclusión de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para la barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Transición suave para el carrusel y el modal */
        .carousel-item, #add-slide-modal, #add-employee-modal {
            transition: opacity 0.5s ease-in-out;
        }
        /* Ajuste para que el contenido no se oculte detrás del header fijo */
        body {
            padding-top: 69px; /* Altura del header (64px) + borde inferior (1px) + borde superior (4px) */
        }
        .modal-enter {
            opacity: 0;
        }
        .modal-enter-active {
            opacity: 1;
            transition: opacity 300ms;
        }
        .modal-leave-active {
            opacity: 0;
            transition: opacity 300ms;
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Barra de Navegación Superior con Branding Corporativo -->
        <header class="bg-white fixed w-full top-0 z-30 shadow-sm border-b border-gray-200 border-t-4 border-[#f5851f]">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Sección Izquierda: Logo y Menú Principal -->
                    <div class="flex items-center space-x-8">
                        <!-- Logo -->
                        <a href="#dashboard" class="flex-shrink-0 flex items-center space-x-2">
                            <img src="https://grupoamalgama.com.mx/imagen/logo.png" alt="Logo Grupo Amalgama" class="h-8 w-auto">
                        </a>
                        <!-- Menú para Escritorio -->
                        <nav class="hidden md:flex h-full items-center space-x-4">
                            <a href="#dashboard" class="nav-link h-full flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Dashboard</a>
                            
                            <!-- Botón Menú "Nosotros" -->
                            <div class="relative h-full flex items-center">
                                <button onclick="toggleMenu('nosotros-menu')" class="nav-link-parent h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700 focus:outline-none">
                                    <span>Nosotros</span>
                                    <svg class="ml-2 h-5 w-5 text-[#87898d]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>

                            <!-- Botón Menú "Herramientas" -->
                            <div class="relative h-full flex items-center">
                                 <button onclick="toggleMenu('herramientas-menu')" class="nav-link-parent h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700 focus:outline-none">
                                    <span>Herramientas</span>
                                    <svg class="ml-2 h-5 w-5 text-[#87898d]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            
                            <!-- Enlace que será visible solo para admin_global y diseno -->
                            <a href="#slideshow-manager" class="nav-link h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700" data-required-profile="admin_global,diseno">Gestionar Slideshow</a>
                        </nav>
                    </div>

                    <!-- Sección Derecha: Menú de Usuario y Botón Móvil -->
                    <div class="flex items-center">
                        <!-- Menú de Usuario -->
                        <div class="hidden md:block relative">
                            <button onclick="toggleMenu('user-menu')" class="bg-white p-1 rounded-full text-[#87898d] hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#0b4d9a]">
                                <span class="sr-only">Abrir menú de usuario</span>
                                <svg class="h-8 w-8 rounded-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-40">
                                <div class="px-4 py-3">
                                    <p class="text-sm">Sesión iniciada como</p>
                                    <p class="text-sm font-medium text-gray-900 truncate" id="user-display-name">Nombre Apellido</p>
                                    <p class="text-xs text-gray-500 capitalize" id="user-display-profile">Perfil</p>
                                </div>
                                <a href="#perfil" class="nav-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mi Perfil</a>
                                <a href="#" onclick="logoutUser(event)" class="block px-4 py-2 text-sm text-gray-700 hover:bg-red-100">Cerrar Sesión</a>
                            </div>
                        </div>
                        <!-- Botón de Menú Móvil -->
                        <div class="-mr-2 flex items-center md:hidden">
                            <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-[#87898d] hover:text-gray-700 hover:bg-gray-100 focus:outline-none">
                                <span class="sr-only">Abrir menú principal</span>
                                <svg id="mobile-menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                                <svg id="mobile-menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CONTENEDOR DE MEGA MENUS (sin cambios en su estructura) -->
            <div class="relative">
                <div id="nosotros-menu" class="hidden absolute w-full bg-white shadow-md border-t border-gray-200 z-20">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-y-10 gap-x-8 px-4 py-8 sm:px-6 lg:px-8">
                        <div>
                            <p class="font-semibold text-gray-900">Nuestra Empresa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#cultura" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Cultura y Valores</a></li>
                                <li><a href="#historia" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Nuestra Historia</a></li>
                                <li><a href="#organigrama" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Organigrama</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Equipo</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#directorio" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Directorio de Empleados</a></li>
                                <li><a href="#beneficios" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Beneficios</a></li>
                                <li><a href="#vacantes" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Vacantes Internas</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Comunicación</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#noticias" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Noticias Internas</a></li>
                                <li><a href="#buzon" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Buzón del Empleado</a></li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg col-span-1">
                             <h3 class="font-semibold text-gray-900">Anuncio Destacado</h3>
                             <p class="mt-2 text-sm text-gray-500">Únete a nuestra próxima jornada de integración este viernes. ¡No te lo pierdas!</p>
                             <a href="#" class="mt-4 inline-block text-sm font-semibold text-[#f5851f] hover:text-[#d9741c]">Saber más &rarr;</a>
                        </div>
                    </div>
                </div>

                <div id="herramientas-menu" class="hidden absolute w-full bg-white shadow-md border-t border-gray-200 z-20">
                     <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-y-10 gap-x-8 px-4 py-8 sm:px-6 lg:px-8">
                        <div>
                            <p class="font-semibold text-gray-900">Gestión Operativa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#orbita" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Órbita (Proyectos)</a></li>
                                <li><a href="#reportes" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Generador de Reportes</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Recursos de la Empresa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#recursos" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Reserva de Activos</a></li>
                                <li><a href="#salas" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Reserva de Salas de Juntas</a></li>
                                <li><a href="#directorio-proveedores" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Directorio de Proveedores</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Capacitación</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#cursos" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Plataforma de Cursos</a></li>
                                <li><a href="#biblioteca" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Biblioteca Digital</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menú Móvil -->
            <div id="mobile-menu" class="hidden md:hidden">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="#dashboard" class="nav-link block pl-3 pr-4 py-2 border-l-4 text-base font-medium">Dashboard</a>
                    <a href="#cultura" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Cultura</a>
                    <a href="#directorio" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Directorio</a>
                    <!-- Enlace que será visible solo para admin_global y diseno -->
                    <a href="#slideshow-manager" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800" data-required-profile="admin_global,diseno">Gestionar Slideshow</a>
                </div>
                <!-- Menú de usuario en móvil -->
                <div class="pt-4 pb-3 border-t border-gray-200">
                    <div class="flex items-center px-4">
                        <div class="flex-shrink-0">
                             <svg class="h-10 w-10 rounded-full text-[#87898d]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" /></svg>
                        </div>
                        <div class="ml-3">
                            <div class="text-base font-medium text-gray-800" id="mobile-user-display-name">Nombre Apellido</div>
                            <div class="text-sm font-medium text-[#87898d]" id="mobile-user-display-profile">Perfil</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        <a href="#perfil" class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Mi Perfil</a>
                        <a href="#" onclick="logoutUser(event)" class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-red-100">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Área de Contenido Dinámico -->
        <main id="main-content" class="max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            <!-- El contenido de los módulos se cargará aquí -->
        </main>
    </div>

    <!-- Modal para Agregar/Editar Slide (Solo visible para admin_global y diseno) -->
    <div id="add-slide-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Agregar Nuevo Slide</h3>
            </div>
            <form id="add-slide-form">
                <!-- CAMPO PARA EL ID DE LA BASE DE DATOS -->
                <input type="hidden" id="slide-edit-id" name="slide-edit-id"> 
                <div class="p-6 space-y-4">
                    <div>
                        <label for="slide-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="slide-title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="slide-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea id="slide-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required></textarea>
                    </div>
                    <div>
                        <label for="slide-image-url" class="block text-sm font-medium text-gray-700 mb-1">URL de la Imagen</label>
                        <input type="url" id="slide-image-url" name="image-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeAddSlideModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm">
                        Guardar Slide
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NUEVO: Modal para Agregar/Editar Empleado -->
    <div id="add-employee-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="employee-modal-title">Agregar Nuevo Empleado</h3>
            </div>
            <form id="add-employee-form">
                <input type="hidden" id="employee-edit-id" name="employee-edit-id"> 
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="employee-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                            <input type="text" id="employee-name" name="nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                        </div>
                        <div>
                            <label for="employee-puesto" class="block text-sm font-medium text-gray-700 mb-1">Puesto</label>
                            <input type="text" id="employee-puesto" name="puesto" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label for="employee-department" class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                            <input type="text" id="employee-department" name="departamento" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                        </div>
                        <div>
                            <label for="employee-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                            <input type="text" id="employee-location" name="ubicacion" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="employee-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="employee-email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                        </div>
                         <div>
                            <label for="employee-phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input type="tel" id="employee-phone" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                        </div>
                    </div>
                    <div>
                        <label for="employee-photo" class="block text-sm font-medium text-gray-700 mb-1">URL Foto (Opcional)</label>
                        <input type="url" id="employee-photo" name="foto_url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeEmployeeModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm">
                        Guardar Empleado
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Variables globales de Autenticación
        let USER = {
            isAuthenticated: false,
            name: 'Invitado',
            profile: 'invitado' // Valores posibles: 'admin_global', 'diseno', 'usuario', 'invitado'
        };

        const PROFILES_CAN_MODIFY_SLIDESHOW = ['admin_global', 'diseno'];
        // Perfil que puede modificar el Directorio
        const PROFILE_CAN_MODIFY_DIRECTORY = 'admin_global'; 

        // --- Lógica de la Interfaz ---
        function toggleMenu(menuId) {
            ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                if (id !== menuId) {
                    document.getElementById(id)?.classList.add('hidden');
                }
            });
            document.getElementById(menuId)?.classList.toggle('hidden');
        }

        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
            document.getElementById('mobile-menu-open-icon').classList.toggle('hidden');
            document.getElementById('mobile-menu-close-icon').classList.toggle('hidden');
        });

        window.addEventListener('click', function(e) {
            if (!e.target.closest('header')) {
                 ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                     document.getElementById(id)?.classList.add('hidden');
                 });
            }
        });


        // --- DATOS MOCK (Para módulos aún no conectados) ---
        const mockNewsData = [
            { title: 'Resultados del Q3 Superan Expectativas', category: 'Finanzas', excerpt: 'El equipo de finanzas reporta un crecimiento del 15%...' },
            { title: 'Próxima Actualización de la Plataforma', category: 'Tecnología', excerpt: 'El equipo de desarrollo lanzará la v2.1 el próximo lunes...' },
            { title: 'Conoce al Nuevo Integrante de Marketing', category: 'RRHH', excerpt: 'Demos la bienvenida a Mateo Rojas, nuestro nuevo Diseñador UI/UX.' },
        ];
        const mockEventsData = [
            { date: '24 Oct', name: 'Reunión General Trimestral' },
            { date: '28 Oct', name: 'Cumpleaños de Ana Sofía' },
            { date: '02 Nov', name: 'Día de Muertos (No Laboral)' },
        ];


        // --- Enrutador Simple del Lado del Cliente ---
        const mainContent = document.getElementById('main-content');
        const API_BASE_URL = 'api/'; // Base para todas las llamadas a la API

        // --- LÓGICA DE AUTENTICACIÓN Y PERFILES ---

        async function checkSession() {
            try {
                const response = await fetch(`${API_BASE_URL}auth_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'check_session' })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    USER.isAuthenticated = true;
                    USER.name = result.data.name;
                    USER.profile = result.data.profile;
                } else {
                    // No hay sesión activa, redirigir a login, excepto si ya estamos allí (para evitar bucle)
                    if (window.location.pathname.indexOf('login.html') === -1) {
                        window.location.href = 'login.html';
                    }
                }
            } catch (error) {
                console.error("Error al verificar la sesión:", error);
                // En caso de error de red, forzar la redirección
                if (window.location.pathname.indexOf('login.html') === -1) {
                    window.location.href = 'login.html';
                }
            }
        }
        
        function updateUIBasedOnAuth() {
            // Actualizar display de usuario
            document.getElementById('user-display-name').innerText = USER.name;
            document.getElementById('user-display-profile').innerText = USER.profile.replace('_', ' ').toUpperCase();
             document.getElementById('mobile-user-display-name').innerText = USER.name;
            document.getElementById('mobile-user-display-profile').innerText = USER.profile.replace('_', ' ').toUpperCase();


            // Control de visibilidad de enlaces por perfil
            document.querySelectorAll('[data-required-profile]').forEach(link => {
                const requiredProfiles = link.getAttribute('data-required-profile').split(',');
                if (requiredProfiles.includes(USER.profile)) {
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            });
        }
        
        async function logoutUser(event) {
            event.preventDefault();
            try {
                await fetch(`${API_BASE_URL}auth_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'logout' })
                });
                // Limpiar estado local y redirigir
                USER.isAuthenticated = false;
                USER.name = 'Invitado';
                USER.profile = 'invitado';
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("Error al intentar cerrar sesión. Inténtalo de nuevo.");
            }
        }


        // --- Funciones para Renderizar Vistas (Módulos) ---

        async function renderDashboard() {
            try {
                // El dashboard siempre carga los slides para el carrusel
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                if (result.status !== 'success') throw new Error(result.message);
                
                let slides = result.data;
                
                let slidesHTML = slides.length > 0 ? slides.map((slide, index) => `
                    <div class="carousel-item absolute inset-0 ${index === 0 ? 'opacity-100' : 'opacity-0'}" data-index="${index}">
                        <img src="${slide.imagen_url}" class="w-full h-full object-cover" alt="${slide.titulo}" onerror="this.onerror=null;this.src='https://placehold.co/1000x400/CCCCCC/333333?text=IMAGEN+NO+DISPONIBLE'">
                        <div class="absolute inset-0 bg-black bg-opacity-40 flex flex-col justify-end p-6 sm:p-8 md:p-12">
                            <h2 class="text-2xl md:text-4xl font-bold text-white shadow-lg">${slide.titulo}</h2>
                            <p class="text-md md:text-lg text-gray-200 mt-2 max-w-3xl">${slide.descripcion}</p>
                        </div>
                    </div>`).join('') : `<div class="bg-gray-800 h-full flex items-center justify-center"><p class="text-white">No hay anuncios para mostrar.</p></div>`;
                
                const newsHTML = mockNewsData.map(item => `
                    <li class="py-3">
                        <div class="flex items-center space-x-3">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${item.title}</p>
                                <p class="text-sm text-gray-500 truncate">${item.excerpt}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${item.category}</span>
                        </div>
                    </li>`).join('');

                const eventsHTML = mockEventsData.map(event => `
                    <li class="flex items-center py-3 space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-lg bg-gray-100 flex flex-col items-center justify-center">
                                <span class="text-sm font-bold text-gray-800">${event.date.split(' ')[1]}</span>
                                <span class="text-xs text-gray-500">${event.date.split(' ')[0]}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800">${event.name}</p>
                        </div>
                    </li>`).join('');

                // Si es solo invitado, solo mostramos el slideshow y un mensaje
                if (USER.profile === 'invitado') {
                    mainContent.innerHTML = `
                        <div class="space-y-8">
                            <h1 class="text-3xl font-bold text-gray-900">Bienvenido, Invitado</h1>
                            <div id="dashboard-carousel" class="relative w-full h-96 bg-gray-900 rounded-xl shadow-lg overflow-hidden">
                                ${slidesHTML}
                                ${slides.length > 1 ? `
                                <button onclick="changeSlide(-1)" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                                <button onclick="changeSlide(1)" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg></button>
                                ` : ''}
                            </div>
                            <div class="p-8 text-center text-gray-600 bg-white rounded-xl shadow-sm">
                                <p class="font-medium">Has iniciado sesión como Invitado. Por favor, inicia sesión con un perfil de usuario para acceder a más funciones de la intranet.</p>
                            </div>
                        </div>`;
                } else {
                    // Contenido completo para usuarios autenticados (usuario, diseno, admin_global)
                    mainContent.innerHTML = `
                        <div class="space-y-8">
                            <h1 class="text-3xl font-bold text-gray-900">Dashboard Principal</h1>
                            <div id="dashboard-carousel" class="relative w-full h-96 bg-gray-900 rounded-xl shadow-lg overflow-hidden">
                                ${slidesHTML}
                                ${slides.length > 1 ? `
                                <button onclick="changeSlide(-1)" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                                <button onclick="changeSlide(1)" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg></button>
                                ` : ''}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-1">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Accesos Rápidos</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                    <a href="#directorio" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-blue-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962a3.75 3.75 0 1 0-5.223-5.223 3.75 3.75 0 0 0 5.223 5.223M1.5 4.5v15h16.5v-15H1.5Z" /></svg><span class="text-sm font-medium text-gray-700">Directorio</span></a>
                                    <a href="#noticias" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-green-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-green-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg><span class="text-sm font-medium text-gray-700">Noticias</span></a>
                                    <a href="#recursos" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-yellow-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-yellow-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 7.125A2.25 2.25 0 0 1 4.5 4.875h15A2.25 2.25 0 0 1 21.75 7.125v10.5A2.25 2.25 0 0 1 19.5 19.875h-15A2.25 2.25 0 0 1 2.25 17.625V7.125Z" /></svg><span class="text-sm font-medium text-gray-700">Reservas</span></a>
                                    <a href="#cursos" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-purple-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-purple-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5Zm0 0v5.5a2.5 2.5 0 0 0 5 0V14" /></svg><span class="text-sm font-medium text-gray-700">Cursos</span></a>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Últimas Noticias</h3><ul class="divide-y divide-gray-200">${newsHTML}</ul></div>
                                <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Próximos Eventos</h3><ul class="divide-y divide-gray-200">${eventsHTML}</ul></div>
                            </div>
                        </div>`;
                }

                window.currentSlideIndex = 0;
                window.totalSlides = slides.length;

            } catch (error) {
                console.error("Error al cargar el dashboard:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar la información del dashboard. Por favor, revisa tu conexión o contacta a soporte.</p></div>`;
            }
        }

        async function renderSlideshowManager() {
            // Restringir acceso al módulo completo
             if (!PROFILES_CAN_MODIFY_SLIDESHOW.includes(USER.profile)) {
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm text-center"><h2 class="text-2xl font-bold text-red-600">Acceso Restringido</h2><p class="mt-2 text-gray-600">No tienes permisos para acceder al gestor de Slideshow.</p></div>`;
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                // Si la API falla por error 403 (Permiso denegado), el resultado JSON lo indica
                if (result.status !== 'success') {
                    if (response.status === 403) {
                         mainContent.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm text-center"><h2 class="text-2xl font-bold text-red-600">Acceso Denegado</h2><p class="mt-2 text-gray-600">${result.message}</p></div>`;
                         return;
                    }
                    throw new Error(result.message);
                }
                
                const slides = result.data;
                window.slidesData = slides; // Almacenamos los datos globalmente para facilitar la edición.
                
                let tableRowsHTML = slides.map(slide => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <img src="${slide.imagen_url}" alt="${slide.titulo}" class="h-12 w-20 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/80x48/CCCCCC/333333?text=IMG'">
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-700 font-medium">${slide.titulo}</td>
                        <td class="py-3 px-4">
                            <button onclick="editSlide(${slide.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                            <button onclick="deleteSlide(${slide.id})" class="ml-4 text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                        </td>
                    </tr>
                `).join('');

                mainContent.innerHTML = `
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">Gestionar Slideshow</h2>
                            <button onclick="openAddSlideModal()" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                Agregar Nuevo Slide
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Imagen</th>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Título</th>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="slides-table-body" class="divide-y divide-gray-200">
                                    ${slides.length > 0 ? tableRowsHTML : '<tr><td colspan="3" class="text-center py-6 text-gray-500">No hay slides para mostrar.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('add-slide-form').addEventListener('submit', handleSaveSlide);

            } catch (error) {
                 console.error("Error al cargar el gestor de slideshow:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar la información. Por favor, revisa tu conexión o contacta a soporte.</p></div>`;
            }
        }

        async function renderDirectorio() {
             if (!USER.isAuthenticated) {
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm text-center"><h2 class="text-2xl font-bold text-red-600">Acceso Restringido</h2><p class="mt-2 text-gray-600">Debes iniciar sesión para ver el Directorio de Empleados.</p></div>`;
                return;
            }
            
            mainContent.innerHTML = `<div class="p-8 text-center text-gray-500">Cargando Directorio...</div>`;
            
            try {
                // 1. Obtener la lista de departamentos para los filtros
                const deptResponse = await fetch(`${API_BASE_URL}directorio_handler.php?action=departments`);
                const deptResult = await deptResponse.json();

                if (deptResult.status !== 'success') throw new Error(deptResult.message);
                
                const departments = ['Todos', ...deptResult.data];
                const filterButtonsHTML = departments.map(dept => `
                    <button class="department-filter whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${dept === 'Todos' ? 'bg-[#0b4d9a] text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}" data-department="${dept}">
                        ${dept}
                    </button>
                `).join('');
                
                // Botón CRUD visible solo para Admin Global
                const crudButton = USER.profile === PROFILE_CAN_MODIFY_DIRECTORY 
                    ? `<button onclick="openEmployeeModal()" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                        Agregar Empleado
                       </button>`
                    : '';


                // 2. Renderizar la estructura del Directorio
                mainContent.innerHTML = `
                    <div class="space-y-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h1 class="text-3xl font-bold text-gray-900">Directorio de Empleados</h1>
                            ${crudButton}
                        </div>
                        
                        <div class="space-y-4">
                            <div class="relative">
                                <input type="search" id="employee-search" placeholder="Buscar por nombre, puesto o correo..." class="w-full rounded-lg border-gray-300 pl-10 pr-4 py-2 focus:border-[#0b4d9a] focus:ring-[#0b4d9a]">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                            <div id="department-filters" class="flex items-center gap-2 overflow-x-auto pb-2">
                                ${filterButtonsHTML}
                            </div>
                        </div>

                        <div id="employee-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    </div>
                `;
                
                // 3. Obtener y mostrar la lista inicial de empleados
                await filterEmployees(); 

                // 4. Configurar Event Listeners
                document.getElementById('employee-search').addEventListener('keyup', filterEmployees);
                document.querySelectorAll('.department-filter').forEach(button => {
                    button.addEventListener('click', () => {
                        // Resaltar el botón activo
                        document.querySelectorAll('.department-filter').forEach(btn => {
                            btn.classList.remove('bg-[#0b4d9a]', 'text-white');
                            btn.classList.add('bg-white', 'text-gray-600');
                        });
                        button.classList.add('bg-[#0b4d9a]', 'text-white');
                        button.classList.remove('bg-white', 'text-gray-600');
                        // Aplicar filtro
                        filterEmployees();
                    });
                });
                
                // Añadir el listener para el formulario del CRUD
                document.getElementById('add-employee-form').addEventListener('submit', handleSaveEmployee);


            } catch (error) {
                console.error("Error al cargar el directorio:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Carga</h3><p class="text-gray-600 mt-2">No se pudo cargar el Directorio. Asegúrate de que la tabla 'empleados' y la API 'directorio_handler.php' estén configuradas correctamente.</p><p class="text-xs text-gray-400 mt-2">Detalle: ${error.message}</p></div>`;
            }
        }

        /**
         * Llama a la API de directorio con los filtros actuales y actualiza la cuadrícula.
         */
        async function filterEmployees() {
            const searchTerm = document.getElementById('employee-search')?.value || '';
            const activeDepartmentBtn = document.querySelector('.department-filter.bg-\\[\\#0b4d9a\\]');
            const activeDepartment = activeDepartmentBtn ? activeDepartmentBtn.dataset.department : 'Todos';

            const grid = document.getElementById('employee-grid');
            if (!grid) return;
            grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">Buscando empleados...</p>';

            try {
                let url = `${API_BASE_URL}directorio_handler.php?search=${encodeURIComponent(searchTerm)}`;
                if (activeDepartment !== 'Todos') {
                    url += `&department=${encodeURIComponent(activeDepartment)}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    window.employeesData = result.data; // Almacenar para edición
                    displayEmployees(result.data);
                } else {
                     grid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error en la API: ${result.message}</p>`;
                }

            } catch (error) {
                 grid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error de conexión al cargar datos.</p>`;
                 console.error("Error en filterEmployees:", error);
            }
        }

        function displayEmployees(employees) {
            const grid = document.getElementById('employee-grid');
            if (!grid) return;
            
            if (employees.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No se encontraron empleados con esos criterios.</p>`;
                return;
            }
            
            const isAdmin = USER.profile === PROFILE_CAN_MODIFY_DIRECTORY;

            grid.innerHTML = employees.map(employee => `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden text-center transform hover:shadow-lg transition-all duration-300">
                    <img class="w-28 h-28 rounded-full mx-auto mt-6 border-4 border-white shadow-md object-cover" src="${employee.foto_url}" alt="Foto de ${employee.nombre}" onerror="this.onerror=null;this.src='https://placehold.co/112x112/CCCCCC/333333?text=USER'">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900">${employee.nombre}</h3>
                        <p class="text-sm text-[#0b4d9a] font-medium">${employee.puesto}</p>
                        <p class="text-xs text-[#f5851f] mt-1">${employee.departamento} (${employee.ubicacion || 'N/A'})</p>
                        <div class="mt-4 border-t pt-4 space-y-2">
                             <a href="mailto:${employee.email}" class="text-sm text-gray-600 hover:text-[#0b4d9a] flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M3 4a2 2 0 0 0-2 2v1.161l8.441 4.221a1.25 1.25 0 0 0 1.118 0L19 7.162V6a2 2 0 0 0-2-2H3Z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 0 1-2.46 0L1 8.839V14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.839Z" /></svg>
                                ${employee.email}
                            </a>
                            ${employee.telefono ? `<a href="tel:${employee.telefono}" class="text-sm text-gray-600 hover:text-[#0b4d9a] flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.109a1.5 1.5 0 0 1 1.488 1.173L7.71 7.23a.75.75 0 0 1-.58 1.054l-1.928.322c-1.353.226-2.072 1.625-1.528 2.809l.342.71c.795 1.653 2.124 2.982 3.778 3.777l.71.342c1.184.544 2.583-.175 2.809-1.528l.322-1.928a.75.75 0 0 1 1.054-.58l4.057 1.527a1.5 1.5 0 0 1 1.173 1.488V16.5A1.5 1.5 0 0 1 16.5 18h-10A8.5 8.5 0 0 1 2 9.5v-6Z" clip-rule="evenodd" /></svg>
                                ${employee.telefono}
                            </a>` : ''}
                        </div>
                        ${isAdmin ? `
                            <div class="mt-4 pt-4 border-t flex justify-center space-x-4">
                                <button onclick="editEmployee(${employee.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                                <button onclick="deleteEmployee(${employee.id})" class="text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // --- Lógica CRUD Directorio (NUEVAS FUNCIONES) ---

        function openEmployeeModal(employeeData = null) {
            if (USER.profile !== PROFILE_CAN_MODIFY_DIRECTORY) return;
            
            const form = document.getElementById('add-employee-form');
            form.reset();
            
            if (employeeData) {
                document.getElementById('employee-modal-title').innerText = 'Editar Empleado';
                document.getElementById('employee-edit-id').value = employeeData.id;
                document.getElementById('employee-name').value = employeeData.nombre;
                document.getElementById('employee-puesto').value = employeeData.puesto;
                document.getElementById('employee-department').value = employeeData.departamento;
                document.getElementById('employee-location').value = employeeData.ubicacion || '';
                document.getElementById('employee-email').value = employeeData.email;
                document.getElementById('employee-phone').value = employeeData.telefono || '';
                document.getElementById('employee-photo').value = employeeData.foto_url || '';
            } else {
                document.getElementById('employee-modal-title').innerText = 'Agregar Nuevo Empleado';
                document.getElementById('employee-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-employee-modal');
            modal.classList.remove('hidden');
            modal.classList.add('modal-enter-active');
        }

        function closeEmployeeModal() {
            const modal = document.getElementById('add-employee-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        async function handleSaveEmployee(event) {
            event.preventDefault();
            if (USER.profile !== PROFILE_CAN_MODIFY_DIRECTORY) return;
            
            const form = event.target;
            const id = form.querySelector('#employee-edit-id').value;
            
            const body = {
                action: id ? 'update' : 'create',
                id: id ? parseInt(id) : null,
                nombre: form.querySelector('#employee-name').value,
                puesto: form.querySelector('#employee-puesto').value,
                departamento: form.querySelector('#employee-department').value,
                ubicacion: form.querySelector('#employee-location').value,
                email: form.querySelector('#employee-email').value,
                telefono: form.querySelector('#employee-phone').value,
                foto_url: form.querySelector('#employee-photo').value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}directorio_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Empleado ${id ? 'actualizado' : 'creado'} con éxito!`);
                    closeEmployeeModal();
                    // Recargar el Directorio para ver los cambios
                    await renderDirectorio(); 
                } else {
                    alert('Error al guardar el empleado: ' + (result.message || 'Error desconocido.'));
                }
            } catch (error) {
                console.error("Error en la petición de guardado de empleado:", error);
                alert('Error de conexión o servidor al guardar empleado.');
            }
        }

        async function editEmployee(id) {
            if (USER.profile !== PROFILE_CAN_MODIFY_DIRECTORY) return;
            const employeeToEdit = window.employeesData.find(e => parseInt(e.id) === id);
            
            if (employeeToEdit) {
                openEmployeeModal(employeeToEdit);
            } else {
                // Si no está en la caché, hacemos una llamada para asegurarnos
                try {
                    const response = await fetch(`${API_BASE_URL}directorio_handler.php?action=get_employee&id=${id}`);
                    const result = await response.json();
                    if (result.status === 'success') {
                         openEmployeeModal(result.data);
                    } else {
                         alert('Error: Empleado no encontrado.');
                    }
                } catch (error) {
                    console.error("Error al obtener empleado para editar:", error);
                    alert('Error al obtener datos del empleado.');
                }
            }
        }

        async function deleteEmployee(id) {
            if (USER.profile !== PROFILE_CAN_MODIFY_DIRECTORY) return;

            if (!confirm('¿Estás seguro de que quieres eliminar este empleado? Esta acción es irreversible.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}directorio_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Empleado eliminado con éxito!');
                    await renderDirectorio();
                } else {
                    alert('Error al eliminar el empleado: ' + (result.message || 'Error desconocido.'));
                }
            } catch (error) {
                console.error("Error en la petición de eliminación de empleado:", error);
                alert('Error de conexión o servidor al eliminar empleado.');
            }
        }
        
        // --- Lógica de Control (CRUD Slideshow) ---
        
        /**
         * Abre el modal, rellenando con datos si se está editando un slide existente.
         * @param {Object} slideData - Los datos del slide a editar (opcional).
         */
        function openAddSlideModal(slideData = null) {
            const form = document.getElementById('add-slide-form');
            form.reset();
            
            if (slideData) {
                document.getElementById('modal-title').innerText = 'Editar Slide Existente';
                document.getElementById('slide-edit-id').value = slideData.id;
                document.getElementById('slide-title').value = slideData.titulo;
                document.getElementById('slide-description').value = slideData.descripcion;
                document.getElementById('slide-image-url').value = slideData.imagen_url;
            } else {
                document.getElementById('modal-title').innerText = 'Agregar Nuevo Slide';
                document.getElementById('slide-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-slide-modal');
            modal.classList.remove('hidden');
            modal.classList.add('modal-enter-active');
        }

        function closeAddSlideModal() {
            const modal = document.getElementById('add-slide-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        /**
         * Maneja el envío del formulario para crear o actualizar un slide.
         * @param {Event} event - El evento de envío del formulario.
         */
        async function handleSaveSlide(event) {
            event.preventDefault();
            
            // Re-verificar permisos antes de enviar
             if (!PROFILES_CAN_MODIFY_SLIDESHOW.includes(USER.profile)) {
                 alert('Acceso denegado. No tienes permisos para modificar el slideshow.');
                 return;
             }
             
            const form = event.target;
            const id = form.querySelector('#slide-edit-id').value;
            const title = form.querySelector('#slide-title').value;
            const description = form.querySelector('#slide-description').value;
            const imageUrl = form.querySelector('#slide-image-url').value;

            const action = id ? 'update' : 'create';
            const method = 'POST';
            
            // Creamos el cuerpo de la petición JSON
            const body = JSON.stringify({
                action: action,
                id: id ? parseInt(id) : null,
                title: title,
                description: description,
                'image-url': imageUrl
            });

            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    // Usamos alert temporalmente, idealmente sería un mensaje flotante más estético
                    alert(`Slide ${action === 'create' ? 'creado' : 'actualizado'} con éxito!`);
                    closeAddSlideModal();
                    // Recargar el módulo para ver los cambios
                    renderSlideshowManager(); 
                } else {
                    alert('Error al guardar el slide: ' + (result.message || 'Error desconocido.'));
                }
            } catch (error) {
                console.error("Error en la petición de guardado:", error);
                alert('Error de conexión o servidor.');
            }
        }

        /**
         * Prepara el modal para editar un slide.
         * @param {number} id - El ID del slide a editar.
         */
        function editSlide(id) {
            if (!window.slidesData) {
                console.error("Datos de slides no cargados.");
                return;
            }
            const slideToEdit = window.slidesData.find(slide => parseInt(slide.id) === id);
            if (slideToEdit) {
                openAddSlideModal(slideToEdit);
            } else {
                alert('Error: Slide no encontrado.');
            }
        }

        /**
         * Elimina un slide mediante una petición al backend.
         * @param {number} id - El ID del slide a eliminar.
         */
        async function deleteSlide(id) {
             // Re-verificar permisos antes de enviar
             if (!PROFILES_CAN_MODIFY_SLIDESHOW.includes(USER.profile)) {
                 alert('Acceso denegado. No tienes permisos para eliminar el slideshow.');
                 return;
             }
            
            if (!confirm('¿Estás seguro de que quieres eliminar este slide? Esta acción es irreversible.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Slide eliminado con éxito!');
                    // Recargar el módulo para ver los cambios
                    renderSlideshowManager();
                } else {
                    alert('Error al eliminar el slide: ' + (result.message || 'Error desconocido.'));
                }
            } catch (error) {
                console.error("Error en la petición de eliminación:", error);
                alert('Error de conexión o servidor.');
            }
        }

        function changeSlide(direction) {
            const slides = document.querySelectorAll('.carousel-item');
            if(slides.length === 0) return;
            slides[window.currentSlideIndex].classList.remove('opacity-100');
            slides[window.currentSlideIndex].classList.add('opacity-0');
            window.currentSlideIndex = (window.currentSlideIndex + direction + window.totalSlides) % window.totalSlides;
            slides[window.currentSlideIndex].classList.remove('opacity-0');
            slides[window.currentSlideIndex].classList.add('opacity-100');
        }

        async function loadModule(moduleName) {
            if (moduleName === 'dashboard') {
                await renderDashboard();
            } else if (moduleName === 'slideshow-manager') {
                await renderSlideshowManager();
            } else if (moduleName === 'directorio') {
                await renderDirectorio();
            }
            else if (moduleName === 'perfil') {
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 capitalize text-gray-800">Mi Perfil</h2>
                    <p class="text-gray-600">Aquí podrás ver y editar tu información personal.</p>
                    <div class="mt-4 p-4 border rounded-lg">
                        <p><strong>Nombre:</strong> ${USER.name}</p>
                        <p><strong>Perfil:</strong> <span class="capitalize">${USER.profile.replace('_', ' ')}</span></p>
                    </div>
                </div>`;
            }
            else {
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4 capitalize text-gray-800">${moduleName.replace(/-/g, ' ')}</h2><p class="text-gray-600">El contenido del módulo '${moduleName}' se cargará aquí...</p></div>`;
            }
            // Aseguramos que los menús móviles y desplegables se cierren al cambiar de módulo
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('mobile-menu-open-icon').classList.remove('hidden');
            document.getElementById('mobile-menu-close-icon').classList.add('hidden');
        }

        function setActiveLink(moduleName) {
            // Limpia todos los enlaces principales
            document.querySelectorAll('nav .nav-link, nav .nav-link-parent').forEach(l => {
                l.classList.remove('border-[#0b4d9a]', 'text-gray-900', 'font-semibold');
                l.classList.add('border-transparent', 'text-[#87898d]');
            });
             // Limpia todos los enlaces móviles
             document.querySelectorAll('#mobile-menu .nav-link').forEach(l => {
                 l.classList.remove('bg-blue-50', 'border-[#0b4d9a]', 'text-[#0b4d9a]');
                 l.classList.add('border-transparent', 'text-gray-600');
             });

            const activeLink = document.querySelector(`.nav-link[href="#${moduleName}"]`);
            if (activeLink) {
                const parentNav = activeLink.closest('nav');
                if (parentNav) {
                    // Estilo para enlaces principales de escritorio
                    activeLink.classList.add('border-[#0b4d9a]', 'text-gray-900', 'font-semibold');
                    activeLink.classList.remove('border-transparent', 'text-[#87898d]');
                }
                const parentDropdown = activeLink.closest('.hidden.absolute');
                if (parentDropdown) {
                    // Si está en un Mega Menú, resalta el botón padre
                    const menuId = parentDropdown.id;
                    const button = document.querySelector(`button[onclick="toggleMenu('${menuId}')"]`);
                    button?.classList.add('text-gray-900', 'font-semibold');
                }
                 const mobileLink = document.querySelector(`#mobile-menu .nav-link[href="#${moduleName}"]`);
                    if(mobileLink){
                        // Estilo para enlaces móviles
                        mobileLink.classList.add('bg-blue-50', 'border-[#0b4d9a]', 'text-[#0b4d9a]');
                        mobileLink.classList.remove('border-transparent', 'text-gray-600');
                    }
            }
        }

        // Listener para los enlaces de navegación
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const module = e.currentTarget.getAttribute('href').substring(1);
                window.location.hash = module;
                // Cierra los menús desplegables de escritorio
                ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                    document.getElementById(id)?.classList.add('hidden');
                });
            });
        });

        // Manejador de cambio de hash para navegación
        async function handleHashChange() {
            // 1. Verificar sesión primero
            await checkSession();
            
            // 2. Si no está autenticado, la función checkSession redirigirá a login.html
            if (!USER.isAuthenticated && window.location.hash !== '#dashboard') return;
            
            // 3. Actualizar la UI (nombres, perfiles, visibilidad de enlaces)
            updateUIBasedOnAuth();

            // 4. Cargar el módulo
            const module = window.location.hash.substring(1) || 'dashboard';
            await loadModule(module);
            setActiveLink(module);
        }

        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('DOMContentLoaded', handleHashChange);
    </script>
</body>
</html>
