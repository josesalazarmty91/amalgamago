<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Interna | Grupo Amalgama</title>
    <!-- Inclusión de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para la barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Transición suave para el carrusel y los modales */
        .carousel-item, .modal-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Ajuste para que el contenido no se oculte detrás del header fijo y el ticker */
        body {
            padding-top: 105px; /* Altura del header (69px) + altura del ticker (36px) */
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        /* Animación para el Ticker de Noticias */
        @keyframes scroll-left {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); }
        }
        #news-ticker-content {
            /* El contenido se duplica con JS para un bucle infinito y suave */
            animation: scroll-left 40s linear infinite;
            white-space: nowrap; /* Asegura que el contenido no se rompa en varias líneas */
        }
        #news-ticker-container:hover #news-ticker-content {
            animation-play-state: paused;
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Barra de Navegación Superior con Branding Corporativo -->
        <header class="bg-white fixed w-full top-0 z-30 shadow-sm border-b border-gray-200 border-t-4 border-[#f5851f]">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Sección Izquierda: Logo y Menú Principal -->
                    <div class="flex items-center space-x-8">
                        <!-- Logo -->
                        <a href="#dashboard" class="flex-shrink-0 flex items-center space-x-2 transition-transform duration-300 hover:scale-110">
                             <img class="h-10 w-auto" src="https://grupoamalgama.com.mx/imagen/logo.png" alt="Grupo Amalgama Logo">
                        </a>
                        <!-- Menú para Escritorio -->
                        <nav class="hidden md:flex h-full items-center space-x-4">
                            <!-- Botón Menú "Nosotros" -->
                            <div class="relative h-full flex items-center">
                                <button onclick="toggleMenu('nosotros-menu')" class="nav-link-parent h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700 focus:outline-none">
                                    <span>Nosotros</span>
                                    <svg class="ml-2 h-5 w-5 text-[#87898d]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>

                            <!-- Botón Menú "Herramientas" -->
                            <div class="relative h-full flex items-center">
                                 <button onclick="toggleMenu('herramientas-menu')" class="nav-link-parent h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700 focus:outline-none">
                                    <span>Herramientas</span>
                                    <svg class="ml-2 h-5 w-5 text-[#87898d]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            
                            <a href="#noticias" class="nav-link h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700">Noticias</a>
                            <a href="#directorio" class="nav-link h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700">Directorio</a>
                            <a href="#slideshow-manager" id="slideshow-link" class="nav-link h-full flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-[#87898d] hover:text-gray-700 hidden">Gestionar Slideshow</a>
                        </nav>
                    </div>

                    <!-- Sección Derecha: Menú de Usuario y Botón Móvil -->
                    <div class="flex items-center">
                        <!-- Menú de Usuario -->
                        <div class="hidden md:block relative">
                            <button onclick="toggleMenu('user-menu')" class="bg-white p-1 rounded-full text-[#87898d] hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#0b4d9a]">
                                <span class="sr-only">Abrir menú de usuario</span>
                                <img id="user-avatar-nav" class="h-8 w-8 rounded-full" src="https://placehold.co/100x100/A0A0A0/FFFFFF?text=P" alt="Avatar">
                            </button>
                            <div id="user-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-40">
                                <div class="px-4 py-3">
                                    <p class="text-sm">Sesión iniciada como</p>
                                    <p id="user-name-menu" class="text-sm font-medium text-gray-900 truncate">...</p>
                                    <p id="user-profile-menu" class="text-xs text-[#f5851f] capitalize mt-1">...</p>
                                </div>
                                <a href="#perfil" class="nav-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mi Perfil</a>
                                <button onclick="logoutUser()" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Cerrar Sesión</button>
                            </div>
                        </div>
                        <!-- Botón de Menú Móvil -->
                        <div class="-mr-2 flex items-center md:hidden">
                            <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-[#87898d] hover:text-gray-700 hover:bg-gray-100 focus:outline-none">
                                <span class="sr-only">Abrir menú principal</span>
                                <svg id="mobile-menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                                <svg id="mobile-menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CONTENEDOR DE MEGA MENUS -->
            <div class="relative">
                <!-- Mega Menu "Nosotros" -->
                <div id="nosotros-menu" class="hidden absolute w-full bg-white shadow-md border-t border-gray-200 z-20">
                    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-y-10 gap-x-8 px-4 py-8 sm:px-6 lg:px-8">
                        <div>
                            <p class="font-semibold text-gray-900">Nuestra Empresa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#cultura" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Cultura y Valores</a></li>
                                <li><a href="#historia" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Nuestra Historia</a></li>
                                <li><a href="#organigrama" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Organigrama</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Equipo</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#directorio" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Directorio de Empleados</a></li>
                                <li><a href="#beneficios" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Beneficios</a></li>
                                <li><a href="#vacantes" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Vacantes Internas</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Comunicación</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#noticias" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Noticias Internas</a></li>
                                <li><a href="#buzon" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Buzón del Empleado</a></li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg col-span-1">
                             <h3 class="font-semibold text-gray-900">KM0, la ruta digital de nuestras historias</h3>
                             <p class="mt-2 text-sm text-gray-500">¡Conoce nuestra revista del mes! Deslúmbrate con el nuevo contenido que hemos preparado para ti.</p>
                             <a href="https://grupoamalgama.com.mx/km0/" target="_blank" rel="noopener noreferrer" class="mt-4 inline-block text-sm font-semibold text-[#f5851f] hover:text-[#d9741c]">Leer ahora &rarr;</a>
                        </div>
                    </div>
                </div>

                <!-- Mega Menu "Herramientas" -->
                <div id="herramientas-menu" class="hidden absolute w-full bg-white shadow-md border-t border-gray-200 z-20">
                     <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-y-10 gap-x-8 px-4 py-8 sm:px-6 lg:px-8">
                        <div>
                            <p class="font-semibold text-gray-900">Gestión Operativa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#orbita" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Órbita (Proyectos)</a></li>
                                <li><a href="#reportes" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">DataVision (Reportes)</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Recursos de la Empresa</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#recursos" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Reserva de Activos</a></li>
                                <li><a href="#salas" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Reserva de Salas de Juntas</a></li>
                                <li><a href="#directorio-proveedores" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Directorio de Proveedores</a></li>
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900">Capacitación</p>
                            <ul class="mt-4 space-y-3">
                                <li><a href="#cursos" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Plataforma de Cursos</a></li>
                                <li><a href="#biblioteca" class="nav-link text-sm text-[#87898d] hover:text-[#0b4d9a] hover:font-medium">Biblioteca Digital</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menú Móvil -->
            <div id="mobile-menu" class="hidden md:hidden">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="#noticias" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Noticias</a>
                    <a href="#directorio" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Directorio</a>
                    <a href="#slideshow-manager" id="slideshow-link-mobile" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800 hidden">Gestionar Slideshow</a>
                </div>
                <!-- Menú de usuario en móvil -->
                <div class="pt-4 pb-3 border-t border-gray-200">
                    <div class="flex items-center px-4">
                        <div class="flex-shrink-0">
                             <img id="user-avatar-mobile" class="h-10 w-10 rounded-full" src="https://placehold.co/100x100/A0A0A0/FFFFFF?text=P" alt="Avatar">
                        </div>
                        <div class="ml-3">
                            <div id="user-name-mobile" class="text-base font-medium text-gray-800">...</div>
                            <div id="user-email-mobile" class="text-sm font-medium text-[#87898d]">...</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        <a href="#perfil" class="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Mi Perfil</a>
                        <button onclick="logoutUser()" class="w-full text-left block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Cinta de Noticias Recientes (Ticker) -->
        <div id="news-ticker-container" class="hidden fixed w-full bg-[#f5851f] text-white text-sm z-20 flex items-center" style="top: 69px; height: 36px;">
            <span class="bg-black bg-opacity-20 font-bold text-xs uppercase px-4 h-full flex items-center flex-shrink-0">ÚLTIMAS NOTICIAS</span>
            <div class="w-full h-full overflow-hidden">
                <div id="news-ticker-content" class="inline-block" style="line-height: 36px;">
                    <!-- El contenido se poblará dinámicamente con JavaScript -->
                </div>
            </div>
        </div>


        <!-- Área de Contenido Dinámico -->
        <main id="main-content" class="max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
            <!-- El contenido de los módulos se cargará aquí -->
        </main>
    </div>

    <!-- Modales -->
    
    <!-- Modal para Agregar/Editar Reporte -->
    <div id="add-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-transition">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="report-modal-title">Agregar Nuevo Reporte</h3>
            </div>
            <form id="add-report-form">
                <input type="hidden" id="report-edit-id">
                <div class="p-6 space-y-4">
                    <div>
                        <label for="report-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Reporte</label>
                        <input type="text" id="report-nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="report-url" class="block text-sm font-medium text-gray-700 mb-1">URL del Reporte</label>
                        <input type="url" id="report-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                     <div>
                        <label for="report-descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción (Opcional)</label>
                        <textarea id="report-descripcion" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]"></textarea>
                    </div>
                    <div>
                        <label for="report-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <input type="text" id="report-categoria" placeholder="Ej: Finanzas, Operaciones, Atención a Clientes" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Permisos de Acceso</label>
                        <div id="report-permissions" class="space-y-2">
                            <!-- Checkboxes de perfiles se cargarán aquí -->
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeReportModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">Cancelar</button>
                    <button type="submit" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm">Guardar Reporte</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal para Agregar/Editar Slide -->
    <div id="add-slide-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-transition modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Agregar Nuevo Slide</h3>
            </div>
            <form id="add-slide-form">
                <input type="hidden" id="slide-edit-id" name="slide-edit-id">
                <div class="p-6 space-y-4">
                    <div>
                        <label for="slide-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="slide-title" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="slide-description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea id="slide-description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required></textarea>
                    </div>
                    <div>
                        <label for="slide-image-url" class="block text-sm font-medium text-gray-700 mb-1">URL de la Imagen</label>
                        <input type="url" id="slide-image-url" name="image-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeAddSlideModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm">
                        Guardar Slide
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Empleado -->
    <div id="add-employee-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-transition modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="employee-modal-title">Agregar Nuevo Empleado</h3>
            </div>
            <form id="add-employee-form">
                <input type="hidden" id="employee-edit-id" name="employee-edit-id">
                <div class="p-6 space-y-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="employee-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                        <input type="text" id="employee-nombre" name="nombre" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="employee-puesto" class="block text-sm font-medium text-gray-700 mb-1">Puesto</label>
                        <input type="text" id="employee-puesto" name="puesto" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="employee-departamento" class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                        <input type="text" id="employee-departamento" name="departamento" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="employee-ubicacion" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                        <input type="text" id="employee-ubicacion" name="ubicacion" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                    </div>
                    <div>
                        <label for="employee-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="employee-email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="employee-telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                        <input type="tel" id="employee-telefono" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                    </div>
                    <div class="md:col-span-2">
                        <label for="employee-foto-url" class="block text-sm font-medium text-gray-700 mb-1">URL Foto (Opcional)</label>
                        <input type="url" id="employee-foto-url" name="foto-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeEmployeeModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm">
                        Guardar Empleado
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Noticia -->
    <div id="add-news-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 modal-transition modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800" id="news-modal-title">Crear Nueva Noticia</h3>
            </div>
            <form id="add-news-form">
                <input type="hidden" id="news-edit-id" name="news-edit-id">
                <div class="p-6 space-y-4">
                    <div>
                        <label for="news-titulo" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                        <input type="text" id="news-titulo" name="titulo" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="news-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <input type="text" id="news-categoria" name="categoria" value="General" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required>
                    </div>
                    <div>
                        <label for="news-extracto" class="block text-sm font-medium text-gray-700 mb-1">Extracto (Resumen corto)</label>
                        <textarea id="news-extracto" name="extracto" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required></textarea>
                    </div>
                    <div>
                        <label for="news-imagen-url" class="block text-sm font-medium text-gray-700 mb-1">URL de la Imagen Destacada (Opcional)</label>
                        <input type="url" id="news-imagen-url" name="imagen-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                    </div>
                    <div>
                        <label for="news-contenido-html" class="block text-sm font-medium text-gray-700 mb-1">Contenido HTML (Soporta etiquetas básicas como &lt;p&gt;, &lt;strong&gt;, &lt;ul&gt;)</label>
                        <textarea id="news-contenido-html" name="contenido-html" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-[#0b4d9a] focus:border-[#0b4d9a]" required></textarea>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end items-center space-x-3">
                    <button type="button" onclick="closeNewsModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-[#0b4d9a] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#083a75] transition-colors shadow-sm">
                        Guardar Noticia
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- VARIABLES GLOBALES ---
        const API_BASE_URL = new URL('api/', window.location.href).href; 
        const mainContent = document.getElementById('main-content');
        const USER_PROFILES = ['admin_global', 'diseno', 'usuario']; // Lista de perfiles para permisos
        let USER = {
            is_authenticated: false,
            id: null,
            name: 'Invitado',
            email: 'invitado@amalgama.com',
            profile: 'invitado',
            photo_url: 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=P'
        };
        let carouselInterval = null;
        let allReportsData = [];

        // --- Lógica de la Interfaz ---
        function toggleMenu(menuId) {
            ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                if (id !== menuId) {
                    document.getElementById(id)?.classList.add('hidden');
                }
            });
            document.getElementById(menuId)?.classList.toggle('hidden');
        }

        document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
            document.getElementById('mobile-menu-open-icon').classList.toggle('hidden');
            document.getElementById('mobile-menu-close-icon').classList.toggle('hidden');
        });

        window.addEventListener('click', function(e) {
            if (!e.target.closest('header')) {
                 ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                     document.getElementById(id)?.classList.add('hidden');
                 });
            }
        });


        // --- AUTENTICACIÓN Y PERFILES ---

        async function loadNewsTicker() {
            try {
                const response = await fetch(`${API_BASE_URL}noticias_handler.php?limit=7`);
                const result = await response.json();
                const tickerContainer = document.getElementById('news-ticker-container');
                const tickerContent = document.getElementById('news-ticker-content');

                if (!tickerContainer || !tickerContent) return;

                if (result.status === 'success' && result.data.length > 0) {
                    const newsItemsHTML = result.data.map(news => `
                        <a href="#noticias/detalle/${news.id}" class="inline-block px-4 hover:underline">
                            ${news.titulo}
                        </a>
                    `).join('<span class="text-white opacity-50 font-light">|</span>');
                    
                    tickerContent.innerHTML = newsItemsHTML + '<span class="text-white opacity-50 font-light mx-4">|</span>' + newsItemsHTML;
                    
                    tickerContainer.classList.remove('hidden');
                } else {
                    tickerContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error al cargar la cinta de noticias:", error);
                document.getElementById('news-ticker-container')?.classList.add('hidden');
            }
        }

        async function checkSession() {
            try {
                const response = await fetch(`${API_BASE_URL}auth_handler.php?action=check_session`);
                const result = await response.json();

                if (result.status === 'success') {
                    USER.is_authenticated = true;
                    USER.id = result.data.id;
                    USER.name = result.data.nombre;
                    USER.email = result.data.email;
                    USER.profile = result.data.perfil;
                    USER.photo_url = result.data.foto_url || 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=P';
                    updateUIForUser();
                    loadNewsTicker();
                    return true;
                } else {
                    if (window.location.pathname.endsWith('login.html') === false) {
                         window.location.href = new URL('login.html', window.location.href).href;
                    }
                    return false;
                }
            } catch (error) {
                console.error("Error al verificar la sesión:", error);
                if (window.location.pathname.endsWith('login.html') === false) {
                     window.location.href = new URL('login.html', window.location.href).href;
                }
                return false;
            }
        }

        function updateUIForUser() {
            document.getElementById('user-name-menu').innerText = USER.name;
            document.getElementById('user-profile-menu').innerText = USER.profile.replace(/_/g, ' ').toUpperCase();
            document.getElementById('user-avatar-nav').src = USER.photo_url;
            document.getElementById('user-name-mobile').innerText = USER.name;
            document.getElementById('user-email-mobile').innerText = USER.email;
            document.getElementById('user-avatar-mobile').src = USER.photo_url;
            
            const canManageSlideshow = ['admin_global', 'diseno'].includes(USER.profile);
            const slideshowLink = document.getElementById('slideshow-link');
            const slideshowLinkMobile = document.getElementById('slideshow-link-mobile');
            if (slideshowLink) slideshowLink.classList.toggle('hidden', !canManageSlideshow);
            if (slideshowLinkMobile) slideshowLinkMobile.classList.toggle('hidden', !canManageSlideshow);
        }

        function logoutUser() {
             fetch(`${API_BASE_URL}auth_handler.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'logout' })
            }).finally(() => {
                window.location.href = new URL('login.html', window.location.href).href;
            });
        }


        // --- Funciones para Renderizar Vistas (Módulos) ---

        async function renderDashboard() {
            try {
                const [slidesResponse, newsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}slideshow_handler.php`),
                    fetch(`${API_BASE_URL}noticias_handler.php?limit=3`)
                ]);

                const slidesResult = await slidesResponse.json();
                const newsResult = await newsResponse.json();

                let slides = slidesResult.status === 'success' ? slidesResult.data : [];
                let slidesHTML = slides.length > 0 ? slides.map((slide, index) => `
                    <div class="carousel-item absolute inset-0 ${index === 0 ? 'opacity-100' : 'opacity-0'}" data-index="${index}">
                        <img src="${slide.imagen_url || 'https://placehold.co/1200x400/94A3B8/FFFFFF?text=SLIDE+SIN+IMAGEN'}" onerror="this.onerror=null; this.src='https://placehold.co/1200x400/94A3B8/FFFFFF?text=SLIDE+SIN+IMAGEN';" class="w-full h-full object-cover" alt="${slide.titulo}">
                        <div class="absolute inset-0 bg-black bg-opacity-40 flex flex-col justify-end p-6 sm:p-8 md:p-12">
                            <h2 class="text-2xl md:text-4xl font-bold text-white shadow-lg">${slide.titulo}</h2>
                            <p class="text-md md:text-lg text-gray-200 mt-2 max-w-3xl">${slide.descripcion}</p>
                        </div>
                    </div>`).join('') : `<div class="bg-gray-800 h-full flex items-center justify-center"><p class="text-white">No hay anuncios para mostrar.</p></div>`;
                
                let newsData = newsResult.status === 'success' ? newsResult.data : [];
                const newsHTML = newsData.map(item => `
                    <li class="py-3">
                        <a href="#noticias/detalle/${item.id}" class="hover:bg-gray-50 block -mx-3 px-3 py-2 rounded-lg transition-colors">
                            <div class="flex items-center space-x-3">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${item.titulo}</p>
                                    <p class="text-sm text-gray-500 truncate">${item.extracto}</p>
                                </div>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${item.categoria}</span>
                            </div>
                        </a>
                    </li>`).join('');

                const eventsHTML = mockEventsData.map(event => `
                    <li class="flex items-center py-3 space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-lg bg-gray-100 flex flex-col items-center justify-center">
                                <span class="text-sm font-bold text-gray-800">${event.date.split(' ')[1]}</span>
                                <span class="text-xs text-gray-500">${event.date.split(' ')[0]}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800">${event.name}</p>
                        </div>
                    </li>`).join('');

                mainContent.innerHTML = `
                    <div class="space-y-8">
                        <div id="dashboard-carousel" class="relative w-full h-96 bg-gray-900 rounded-xl shadow-lg overflow-hidden">
                            ${slidesHTML}
                            ${slides.length > 1 ? `
                            <button onclick="navigateAndResetInterval(-1)" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button>
                            <button onclick="navigateAndResetInterval(1)" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/60 hover:bg-white/90 text-gray-800 p-2 rounded-full z-10 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg></button>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Accesos Rápidos</h3>
                                <div class="grid grid-cols-2 gap-4">
                                <a href="#directorio" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-blue-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962a3.75 3.75 0 1 0-5.223-5.223 3.75 3.75 0 0 0 5.223 5.223M1.5 4.5v15h16.5v-15H1.5Z" /></svg><span class="text-sm font-medium text-gray-700">Directorio</span></a>
                                <a href="#noticias" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-green-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-green-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg><span class="text-sm font-medium text-gray-700">Noticias</span></a>
                                <a href="#recursos" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-yellow-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-yellow-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 7.125A2.25 2.25 0 0 1 4.5 4.875h15A2.25 2.25 0 0 1 21.75 7.125v10.5A2.25 2.25 0 0 1 19.5 19.875h-15A2.25 2.25 0 0 1 2.25 17.625V7.125Z" /></svg><span class="text-sm font-medium text-gray-700">Reservas</span></a>
                                <a href="#cursos" class="nav-link flex flex-col items-center justify-center p-4 bg-gray-50 hover:bg-purple-100 rounded-lg transition-colors"><svg class="h-8 w-8 text-purple-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5Zm0 0v5.5a2.5 2.5 0 0 0 5 0V14" /></svg><span class="text-sm font-medium text-gray-700">Cursos</span></a>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Últimas Noticias</h3><ul class="divide-y divide-gray-200">${newsHTML}</ul></div>
                            <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Próximos Eventos</h3><ul class="divide-y divide-gray-200">${eventsHTML}</ul></div>
                        </div>
                    </div>`;
                window.currentSlideIndex = 0;
                window.totalSlides = slides.length;

                if (window.carouselInterval) {
                    clearInterval(window.carouselInterval);
                }
                
                if (window.totalSlides > 1) {
                    window.carouselInterval = setInterval(() => {
                        changeSlide(1);
                    }, 10000);
                }

            } catch (error) {
                console.error("Error al cargar el dashboard:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar la información del dashboard.</p></div>`;
            }
        }

        async function renderSlideshowManager() {
            if (!['admin_global', 'diseno'].includes(USER.profile)) {
                 mainContent.innerHTML = `<div class="bg-white p-8 rounded-xl shadow-sm text-center"><h2 class="text-2xl font-bold mb-4 text-red-600">Acceso Denegado</h2><p class="text-gray-600">No tienes permisos para gestionar el Slideshow.</p></div>`;
                 return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const slides = result.data;
                window.slidesData = slides; 
                
                let tableRowsHTML = slides.map(slide => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <img src="${slide.imagen_url || 'https://placehold.co/80x40/94A3B8/FFFFFF?text=Sin+Imagen'}" onerror="this.onerror=null; this.src='https://placehold.co/80x40/94A3B8/FFFFFF?text=Sin+Imagen';" class="h-12 w-20 object-cover rounded-md">
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-700 font-medium">${slide.titulo}</td>
                        <td class="py-3 px-4">
                            <button onclick="editSlide(${slide.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                            <button onclick="deleteSlide(${slide.id})" class="ml-4 text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                        </td>
                    </tr>
                `).join('');

                mainContent.innerHTML = `
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800">Gestionar Slideshow</h2>
                            <button onclick="openAddSlideModal()" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                Agregar Nuevo Slide
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Imagen</th>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Título</th>
                                        <th class="text-left py-3 px-4 font-semibold text-sm text-gray-600 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="slides-table-body" class="divide-y divide-gray-200">
                                    ${slides.length > 0 ? tableRowsHTML : '<tr><td colspan="3" class="text-center py-6 text-gray-500">No hay slides para mostrar.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('add-slide-form').addEventListener('submit', handleSaveSlide);

            } catch (error) {
                 console.error("Error al cargar el gestor de slideshow:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar la información.</p></div>`;
            }
        }

        async function renderDirectorio() {
            try {
                const response = await fetch(`${API_BASE_URL}directorio_handler.php`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                const employees = result.data;
                window.allEmployeesData = employees; 
                const departments = ['Todos', ...new Set(employees.map(e => e.departamento))];
                const filterButtonsHTML = departments.map(dept => `
                    <button class="department-filter whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-colors ${dept === 'Todos' ? 'bg-[#0b4d9a] text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}" data-department="${dept}">
                        ${dept}
                    </button>
                `).join('');
                
                const canManage = USER.profile === 'admin_global';
                const addButtonHTML = canManage ? `
                    <button onclick="openEmployeeModal()" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                        Agregar Empleado
                    </button>
                ` : '';

                mainContent.innerHTML = `
                    <div class="space-y-8">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">Directorio de Empleados</h1>
                                <p class="mt-1 text-gray-500">Encuentra a tus compañeros de equipo.</p>
                            </div>
                            ${addButtonHTML}
                        </div>
                        
                        <div class="space-y-4">
                            <div class="relative">
                                <input type="search" id="employee-search" placeholder="Buscar por nombre, puesto o departamento..." class="w-full rounded-lg border-gray-300 pl-10 pr-4 py-2 focus:border-[#0b4d9a] focus:ring-[#0b4d9a]">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" /></svg>
                                </div>
                            </div>
                            <div id="department-filters" class="flex items-center gap-2 overflow-x-auto pb-2">
                                ${filterButtonsHTML}
                            </div>
                        </div>

                        <div id="employee-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    </div>
                `;
                
                displayEmployees(employees); 

                document.getElementById('employee-search').addEventListener('keyup', filterEmployees);
                document.getElementById('department-filters').addEventListener('click', (e) => {
                    if (e.target.classList.contains('department-filter')) {
                        document.querySelectorAll('.department-filter').forEach(btn => {
                            btn.classList.remove('bg-[#0b4d9a]', 'text-white');
                            btn.classList.add('bg-white', 'text-gray-600');
                        });
                        e.target.classList.add('bg-[#0b4d9a]', 'text-white');
                        e.target.classList.remove('bg-white', 'text-gray-600');
                        filterEmployees();
                    }
                });
                 document.getElementById('add-employee-form')?.addEventListener('submit', handleSaveEmployee);


            } catch (error) {
                console.error("Error al cargar el directorio:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar el directorio.</p></div>`;
            }
        }

        function displayEmployees(employees) {
            const grid = document.getElementById('employee-grid');
            if (!grid) return;
            
            if (employees.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No se encontraron empleados con esos criterios.</p>`;
                return;
            }
            const canManage = USER.profile === 'admin_global';

            grid.innerHTML = employees.map(employee => `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden text-center transform hover:scale-[1.02] transition-transform duration-300">
                    <img class="w-28 h-28 rounded-full mx-auto mt-6 border-4 border-white shadow-md object-cover" 
                         src="${employee.foto_url || 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=P'}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x100/A0A0A0/FFFFFF?text=P';"
                         alt="Foto de ${employee.nombre}">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900">${employee.nombre}</h3>
                        <p class="text-sm text-[#f5851f] font-medium">${employee.puesto}</p>
                        <p class="text-xs text-gray-500 mt-1">${employee.departamento}${employee.ubicacion ? ` (${employee.ubicacion})` : ''}</p>
                        <div class="mt-4 border-t pt-4 space-y-2">
                            <a href="mailto:${employee.email}" class="text-sm text-gray-600 hover:text-[#0b4d9a] flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M3 4a2 2 0 0 0-2 2v1.161l8.441 4.221a1.25 1.25 0 0 0 1.118 0L19 7.162V6a2 2 0 0 0-2-2H3Z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 0 1-2.46 0L1 8.839V14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.839Z" /></svg>
                                ${employee.email}
                            </a>
                            ${employee.telefono ? `<a href="tel:${employee.telefono}" class="text-sm text-gray-600 hover:text-[#0b4d9a] flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h13A1.5 1.5 0 0 1 18 3.5v13a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 2 16.5v-13ZM15.5 14.5a.75.75 0 0 0 1.5 0v-11a.75.75 0 0 0-1.5 0v11Z" clip-rule="evenodd" /><path d="M11 9.5a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" /><path d="M14.25 10.75a.75.75 0 0 0 0-1.5h-8.5a.75.75 0 0 0 0 1.5h8.5Z" /></svg>
                                ${employee.telefono}
                            </a>` : ''}
                        </div>
                        ${canManage ? `
                            <div class="mt-4 pt-4 border-t flex justify-center space-x-4">
                                <button onclick="editEmployee(${employee.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                                <button onclick="deleteEmployee(${employee.id})" class="text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function renderNoticias(id = null) {
            try {
                if (id) {
                    await renderNoticiaDetalle(id);
                    return;
                }

                const response = await fetch(`${API_BASE_URL}noticias_handler.php?limit=100`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const noticias = result.data;
                window.noticiasData = noticias; // Almacenamos para edición
                const canManage = USER.profile === 'admin_global';

                const newsListHTML = noticias.map(n => `
                    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-start">
                            <img src="${n.imagen_url || 'https://placehold.co/100x100/CCCCCC/333333?text=NEWS'}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/CCCCCC/333333?text=NEWS';" class="w-24 h-24 object-cover rounded-lg mr-4 flex-shrink-0">
                            <div class="flex-1">
                                <span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">${n.categoria}</span>
                                <h3 class="mt-2 text-xl font-bold text-gray-800 hover:text-[#0b4d9a] cursor-pointer" onclick="window.location.hash = 'noticias/detalle/${n.id}'">${n.titulo}</h3>
                                <p class="mt-2 text-gray-600 text-sm">${n.extracto}</p>
                                <p class="mt-3 text-xs text-gray-400">Publicado: ${new Date(n.fecha_publicacion).toLocaleDateString()}</p>
                                ${canManage ? `
                                    <div class="mt-4 flex space-x-4">
                                        <button onclick="editNews(${n.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                                        <button onclick="deleteNews(${n.id})" class="text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                mainContent.innerHTML = `
                    <div class="space-y-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h1 class="text-3xl font-bold text-gray-900">Noticias Internas</h1>
                            ${canManage ? `<button onclick="openNewsModal()" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                Publicar Noticia
                            </button>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${noticias.length > 0 ? newsListHTML : '<div class="col-span-full text-center py-10 text-gray-500">No hay noticias publicadas.</div>'}
                        </div>
                    </div>
                `;
                 document.getElementById('add-news-form')?.addEventListener('submit', handleSaveNews);

            } catch (error) {
                console.error("Error al cargar la lista de noticias:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar la lista de noticias.</p></div>`;
            }
        }

        async function renderNoticiaDetalle(id) {
             try {
                const response = await fetch(`${API_BASE_URL}noticias_handler.php?id=${id}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const n = result.data;

                mainContent.innerHTML = `
                    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                        <a href="#noticias" class="text-[#0b4d9a] hover:text-[#083a75] font-medium p-6 block">&larr; Volver a Noticias</a>
                        <img class="w-full h-80 object-cover" src="${n.imagen_url || 'https://placehold.co/1200x400/94A3B8/FFFFFF?text=IMAGEN+DESTACADA'}" onerror="this.onerror=null; this.src='https://placehold.co/1200x400/94A3B8/FFFFFF?text=IMAGEN+DESTACADA';" alt="${n.titulo}">
                        <div class="p-8 space-y-6">
                            <span class="inline-flex items-center px-4 py-1 text-sm font-semibold rounded-full bg-[#f5851f] text-white">${n.categoria}</span>
                            <h1 class="text-4xl font-extrabold text-gray-900">${n.titulo}</h1>
                            <p class="text-gray-500 text-sm">Publicado: ${new Date(n.fecha_publicacion).toLocaleDateString()} | Resumen: ${n.extracto}</p>
                            <div class="prose max-w-none text-gray-700 leading-relaxed border-t pt-6">
                                ${n.contenido_html}
                            </div>
                            <div class="border-t pt-4">
                                <a href="#noticias" class="text-[#0b4d9a] hover:text-[#083a75] font-medium">&larr; Volver a la lista de Noticias</a>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Error al cargar el detalle de la noticia:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error al cargar la noticia</h3><p class="text-gray-600 mt-2">No se encontró la noticia solicitada o hubo un error de conexión.</p></div>`;
            }
        }

        async function renderCultura() {
            mainContent.innerHTML = `
                <div class="space-y-12">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Cultura y Valores</h1>
                        <p class="mt-2 text-lg text-gray-600">Nuestros principios y compromisos que nos guían como empresa.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Misión -->
                        <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                            <h2 class="text-2xl font-bold text-[#0b4d9a] mb-4">Misión</h2>
                            <p class="text-gray-700 leading-relaxed">
                                Brindar soluciones de transporte de carga regular y especializada, creando una tradición de servicio, cumpliendo con las expectativas del cliente, mediante la correcta utilización de nuestros recursos y el apoyo de nuestro capital humano.
                            </p>
                        </div>

                        <!-- Visión -->
                        <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                            <h2 class="text-2xl font-bold text-[#0b4d9a] mb-4">Visión</h2>
                            <p class="text-gray-700 leading-relaxed">
                                Ser la mejor opción del mercado en carga regular y especializada mediante la optimización e innovación de nuestros sistemas y servicios que garanticen la satisfacción de nuestros clientes, respetando el medio ambiente.
                            </p>
                        </div>
                    </div>

                    <!-- Política de Calidad -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#f5851f] mb-4">Política de calidad</h2>
                        <p class="text-gray-700 leading-relaxed">
                            Ser una empresa comprometida con la conservación y recuperación de los recursos naturales, mediante la minimización de los impactos y riesgos a la salud y al medio ambiente, a través de la prevención y gestión integral de los residuos, así como también con la seguridad que nos confían nuestros clientes, mediante la implementación de procesos para la reducción de riesgos en la cadena logística, ambos en la búsqueda de la mejora continua y bajo el marco legal correspondiente.
                        </p>
                    </div>

                    <!-- Responsabilidad Social -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#f5851f] mb-4">Responsabilidad social</h2>
                        <p class="text-gray-700 leading-relaxed">
                            Como parte de nuestra responsabilidad social, desde hace 4 años estamos involucrados en la certificación SARI; la cual busca el cuidado y crecimiento de nuestro personal, así como los aspectos relacionados al medio ambiente, seguridad e higiene; también por 4 años consecutivos hemos sido reconocidos como empresa de excelencia en el reconocimiento de TRANSPORTE LIMPIO, por nuestras buenas prácticas operativas.
                        </p>
                    </div>

                    <!-- Certificaciones -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-[#f5851f] mb-4">Certificaciones</h2>
                        <p class="text-gray-700 leading-relaxed mb-6">
                            El gran compromiso que brindamos hacia nuestros clientes, siempre está respaldado con una constante mejora de nuestro servicio, por ello nuestras certificaciones nos avalan.
                        </p>
                        <div class="flex flex-wrap items-center justify-center gap-8">
                            <img src="https://placehold.co/150x80/E2E8F0/A0AEC0?text=SARI" alt="Certificación SARI" class="h-20">
                            <img src="https://placehold.co/150x80/E2E8F0/A0AEC0?text=Transporte+Limpio" alt="Certificación Transporte Limpio" class="h-20">
                            <img src="https://placehold.co/150x80/E2E8F0/A0AEC0?text=ISO+9001" alt="Certificación ISO 9001" class="h-20">
                            <img src="https://placehold.co/150x80/E2E8F0/A0AEC0?text=C-TPAT" alt="Certificación C-TPAT" class="h-20">
                        </div>
                    </div>
                </div>
            `;
        }


        async function renderProfile() {
            try {
                const response = await fetch(`${API_BASE_URL}auth_handler.php?action=get_profile`);
                const result = await response.json();

                if (result.status === 'success') {
                    const data = result.data;
                    USER.name = data.nombre;
                    USER.email = data.email;
                    USER.profile = data.perfil;
                    USER.photo_url = data.foto_url || 'https://placehold.co/100x100/A0A0A0/FFFFFF?text=P';
                    updateUIForUser();
                } else {
                    console.error("Error al cargar perfil:", result.message);
                }

            } catch (error) {
                console.error("Error de conexión al cargar perfil:", error);
            }

            mainContent.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Mi Perfil</h1>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden p-6 sm:p-8">
                        
                        <div class="flex items-center space-x-4 border-b pb-6 mb-6">
                            <img class="w-20 h-20 rounded-full object-cover border-4 border-[#f5851f]" src="${USER.photo_url}" onerror="this.onerror=null; this.src='https://placehold.co/100x100/A0A0A0/FFFFFF?text=P';" alt="Foto de perfil">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">${USER.name}</h2>
                                <p class="text-md text-gray-500">${USER.email}</p>
                                <span class="inline-block mt-1 px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 capitalize">${USER.profile.replace(/_/g, ' ')}</span>
                            </div>
                        </div>

                        <div class="border-b border-gray-200">
                            <nav class="flex space-x-4" aria-label="Tabs">
                                <button type="button" onclick="showProfileTab('general')" id="tab-general" class="tab-button inline-flex items-center px-3 py-2 border-b-2 font-medium text-sm text-[#0b4d9a] border-[#0b4d9a]">
                                    Información General
                                </button>
                                <button type="button" onclick="showProfileTab('password')" id="tab-password" class="tab-button inline-flex items-center px-3 py-2 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent">
                                    Seguridad y Contraseña
                                </button>
                            </nav>
                        </div>
                        
                        <div class="mt-8">
                            <div id="content-general" class="tab-content">
                                <form id="profile-update-form" class="space-y-6">
                                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                                        <div class="sm:col-span-6">
                                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                            <input type="text" id="profile-name" value="${USER.name}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                                        </div>
                                        <div class="sm:col-span-6">
                                            <label for="profile-photo-url" class="block text-sm font-medium text-gray-700">URL de la Foto de Perfil</label>
                                            <input type="url" id="profile-photo-url" value="${USER.photo_url}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                                        </div>
                                    </div>
                                    <div class="pt-5">
                                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#f5851f] hover:bg-[#d9741c] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#f5851f]">
                                            Guardar Cambios
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <div id="content-password" class="tab-content hidden">
                                <form id="password-change-form" class="space-y-6">
                                    <div>
                                        <label for="current-password" class="block text-sm font-medium text-gray-700">Contraseña Actual</label>
                                        <input type="password" id="current-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                                    </div>
                                    <div>
                                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                        <input type="password" id="new-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                                    </div>
                                    <div>
                                        <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                                        <input type="password" id="confirm-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-[#0b4d9a] focus:border-[#0b4d9a]">
                                    </div>
                                    <div class="pt-5">
                                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                            Cambiar Contraseña
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('profile-update-form')?.addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-change-form')?.addEventListener('submit', handlePasswordChange);
        }
        
        // --- Reportes Module ---
        async function renderReportes() {
            try {
                const response = await fetch(`${API_BASE_URL}reportes_handler.php`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                
                const groupedReports = result.data;
                window.allReportsData = Object.values(groupedReports).flat();

                const isAdmin = USER.profile === 'admin_global';
                
                const categoriesHTML = Object.keys(groupedReports).map(category => {
                    const reportsHTML = groupedReports[category].map(report => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group">
                            <a href="#reportes/view/${report.id}" class="nav-link block p-6">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-xl text-[#0b4d9a] group-hover:text-[#f5851f] transition-colors">${report.nombre}</h3>
                                        <p class="text-gray-500 text-sm mt-1">${report.descripcion || 'Sin descripción.'}</p>
                                    </div>
                                    <div class="text-gray-300 group-hover:text-[#f5851f] transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                </div>
                            </a>
                            ${isAdmin ? `
                            <div class="bg-gray-50 px-6 py-3 border-t">
                                <div class="flex items-center justify-end space-x-4">
                                    <button onclick="editReport(${report.id})" class="text-sm font-medium text-blue-600 hover:text-blue-800">Editar</button>
                                    <button onclick="deleteReport(${report.id})" class="text-sm font-medium text-red-600 hover:text-red-800">Eliminar</button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `).join('');

                    return `
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-gray-800 border-b-2 border-[#f5851f] pb-2">${category}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${reportsHTML}
                            </div>
                        </div>
                    `;
                }).join('');

                mainContent.innerHTML = `
                    <div class="space-y-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">DataVision - Gestor de Reportes</h1>
                                <p class="mt-1 text-gray-500">Accede a los reportes o gestiona los enlaces y permisos.</p>
                            </div>
                            ${isAdmin ? `<button onclick="openReportModal()" class="bg-[#f5851f] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#d9741c] transition-colors shadow-sm flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                                Agregar Reporte
                            </button>` : ''}
                        </div>
                        <div class="space-y-8">
                            ${Object.keys(groupedReports).length > 0 ? categoriesHTML : '<div class="text-center py-10 text-gray-500 bg-white rounded-lg shadow-sm">No hay reportes disponibles para tu perfil.</div>'}
                        </div>
                    </div>
                `;

                document.getElementById('add-report-form')?.addEventListener('submit', handleSaveReport);

            } catch(error) {
                console.error("Error al cargar los reportes:", error);
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm text-center"><h3 class="text-lg font-semibold text-red-600">Error de Conexión</h3><p class="text-gray-600 mt-2">No se pudo cargar el módulo de reportes.</p></div>`;
            }
        }
        
        function renderReportViewer(id) {
            const report = window.allReportsData.find(r => r.id == id);
            if (!report) {
                mainContent.innerHTML = `<div class="text-center py-10"><h2 class="text-2xl font-bold text-red-600">Error</h2><p class="text-gray-600">No se pudo encontrar el reporte solicitado.</p><a href="#reportes" class="nav-link mt-4 inline-block bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Volver a la lista</a></div>`;
                return;
            }

            mainContent.innerHTML = `
                <div class="flex flex-col" style="height: calc(100vh - 180px);">
                    <div class="flex items-center justify-between mb-4 flex-shrink-0">
                        <h1 class="text-2xl font-bold text-gray-900 truncate">${report.nombre}</h1>
                         <div class="flex items-center space-x-2">
                             <button onclick="toggleFullscreen('report-iframe-container')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-2 rounded-lg transition-colors" title="Ver en pantalla completa">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5 5" />
                                </svg>
                            </button>
                            <a href="#reportes" class="nav-link bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0">
                                &larr; Volver
                            </a>
                        </div>
                    </div>
                    <div id="report-iframe-container" class="flex-grow w-full h-full bg-gray-200 rounded-lg">
                        <iframe src="${report.url}" class="w-full h-full border-0 rounded-lg shadow-inner" title="${report.nombre}"></iframe>
                    </div>
                </div>
            `;
        }


        // --- LÓGICA DE CONTROL ---

        function toggleFullscreen(elemId) {
            const elem = document.getElementById(elemId);
            if (!elem) return;

            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function showProfileTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('text-[#0b4d9a]', 'border-[#0b4d9a]');
                btn.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
            });

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.add('text-[#0b4d9a]', 'border-[#0b4d9a]');
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');

            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        async function handleProfileUpdate(event) {
            event.preventDefault();
            const newName = document.getElementById('profile-name').value;
            const newPhotoUrl = document.getElementById('profile-photo-url').value;

            try {
                const response = await fetch(`${API_BASE_URL}auth_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_profile',
                        nombre: newName,
                        foto_url: newPhotoUrl
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Perfil actualizado con éxito. La página se recargará.');
                    await checkSession(); 
                    renderProfile();
                } else {
                    alert('Error al actualizar el perfil: ' + result.message);
                }
            } catch (error) {
                console.error("Error en la petición de actualización de perfil:", error);
                alert('Error de conexión o servidor.');
            }
        }

        async function handlePasswordChange(event) {
            event.preventDefault();
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (newPass !== confirmPass) {
                alert('La nueva contraseña y su confirmación no coinciden.');
                return;
            }

            try {
                 const response = await fetch(`${API_BASE_URL}auth_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'change_password',
                        current_password: currentPass,
                        new_password: newPass
                    })
                });
                
                const result = await response.json();

                if (result.status === 'success') {
                    alert('Contraseña actualizada con éxito. Por seguridad, debe iniciar sesión nuevamente.');
                    logoutUser();
                } else {
                    alert('Error al cambiar la contraseña: ' + result.message);
                }

            } catch (error) {
                console.error("Error en la petición de cambio de contraseña:", error);
                alert('Error de conexión o servidor.');
            }
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('employee-search').value.toLowerCase();
            const activeDepartmentBtn = document.querySelector('.department-filter.bg-\\[\\#0b4d9a\\]');
            const activeDepartment = activeDepartmentBtn ? activeDepartmentBtn.dataset.department : 'Todos';
            
            const filteredEmployees = window.allEmployeesData.filter(employee => {
                const searchMatch = (
                    employee.nombre.toLowerCase().includes(searchTerm) ||
                    employee.puesto.toLowerCase().includes(searchTerm) ||
                    employee.departamento.toLowerCase().includes(searchTerm)
                );
                const departmentMatch = activeDepartment === 'Todos' || employee.departamento === activeDepartment;
                return searchMatch && departmentMatch;
            });
            displayEmployees(filteredEmployees);
        }

        function openAddSlideModal(slideData = null) {
            const form = document.getElementById('add-slide-form');
            form.reset();
            
            if (slideData) {
                document.getElementById('modal-title').innerText = 'Editar Slide Existente';
                document.getElementById('slide-edit-id').value = slideData.id;
                document.getElementById('slide-title').value = slideData.titulo;
                document.getElementById('slide-description').value = slideData.descripcion;
                document.getElementById('slide-image-url').value = slideData.imagen_url;
            } else {
                document.getElementById('modal-title').innerText = 'Agregar Nuevo Slide';
                document.getElementById('slide-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-slide-modal');
            modal.classList.remove('hidden', 'modal-leave-active');
            modal.classList.add('modal-enter-active');
        }

        function closeAddSlideModal() {
            const modal = document.getElementById('add-slide-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        async function handleSaveSlide(event) {
            event.preventDefault();
            const form = event.target;
            const id = form.querySelector('#slide-edit-id').value;
            const action = id ? 'update' : 'create';
            
            const body = JSON.stringify({
                action: action,
                id: id ? parseInt(id) : null,
                title: form.querySelector('#slide-title').value,
                description: form.querySelector('#slide-description').value,
                'image-url': form.querySelector('#slide-image-url').value
            });

            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Slide ${action === 'create' ? 'creado' : 'actualizado'} con éxito!`);
                    closeAddSlideModal();
                    renderSlideshowManager(); 
                    renderDashboard();
                } else {
                    alert('Error al guardar el slide: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function editSlide(id) {
            const slideToEdit = window.slidesData.find(slide => parseInt(slide.id) === id);
            if (slideToEdit) {
                openAddSlideModal(slideToEdit);
            } else {
                alert('Error: Slide no encontrado.');
            }
        }

        async function deleteSlide(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este slide?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}slideshow_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Slide eliminado con éxito!');
                    renderSlideshowManager();
                    renderDashboard();
                } else {
                    alert('Error al eliminar el slide: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function openEmployeeModal(employeeData = null) {
            const form = document.getElementById('add-employee-form');
            form.reset();
            
            if (employeeData) {
                document.getElementById('employee-modal-title').innerText = 'Editar Empleado';
                document.getElementById('employee-edit-id').value = employeeData.id;
                document.getElementById('employee-nombre').value = employeeData.nombre;
                document.getElementById('employee-puesto').value = employeeData.puesto;
                document.getElementById('employee-departamento').value = employeeData.departamento;
                document.getElementById('employee-ubicacion').value = employeeData.ubicacion;
                document.getElementById('employee-email').value = employeeData.email;
                document.getElementById('employee-telefono').value = employeeData.telefono;
                document.getElementById('employee-foto-url').value = employeeData.foto_url;
            } else {
                document.getElementById('employee-modal-title').innerText = 'Agregar Nuevo Empleado';
                document.getElementById('employee-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-employee-modal');
            modal.classList.remove('hidden', 'modal-leave-active');
            modal.classList.add('modal-enter-active');
        }

        function closeEmployeeModal() {
            const modal = document.getElementById('add-employee-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleSaveEmployee(event) {
            event.preventDefault();
            const form = event.target;
            const id = form.querySelector('#employee-edit-id').value;
            const action = id ? 'update' : 'create';
            
            const body = JSON.stringify({
                action: action,
                id: id ? parseInt(id) : null,
                nombre: form.querySelector('#employee-nombre').value,
                puesto: form.querySelector('#employee-puesto').value,
                departamento: form.querySelector('#employee-departamento').value,
                ubicacion: form.querySelector('#employee-ubicacion').value,
                email: form.querySelector('#employee-email').value,
                telefono: form.querySelector('#employee-telefono').value,
                foto_url: form.querySelector('#employee-foto-url').value,
            });

            try {
                const response = await fetch(`${API_BASE_URL}directorio_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Empleado ${action === 'create' ? 'creado' : 'actualizado'} con éxito!`);
                    closeEmployeeModal();
                    renderDirectorio(); 
                } else {
                    alert('Error al guardar el empleado: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function editEmployee(id) {
            const employeeToEdit = window.allEmployeesData.find(e => parseInt(e.id) === id);
            if (employeeToEdit) {
                openEmployeeModal(employeeToEdit);
            } else {
                alert('Error: Empleado no encontrado.');
            }
        }

        async function deleteEmployee(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar a este empleado?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}directorio_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Empleado eliminado con éxito!');
                    renderDirectorio();
                } else {
                    alert('Error al eliminar el empleado: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function openNewsModal(newsData = null) {
            const form = document.getElementById('add-news-form');
            form.reset();
            
            if (newsData) {
                document.getElementById('news-modal-title').innerText = 'Editar Noticia';
                document.getElementById('news-edit-id').value = newsData.id;
                document.getElementById('news-titulo').value = newsData.titulo;
                document.getElementById('news-extracto').value = newsData.extracto;
                document.getElementById('news-contenido-html').value = newsData.contenido_html;
                document.getElementById('news-imagen-url').value = newsData.imagen_url;
                document.getElementById('news-categoria').value = newsData.categoria;
            } else {
                document.getElementById('news-modal-title').innerText = 'Crear Nueva Noticia';
                document.getElementById('news-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-news-modal');
            modal.classList.remove('hidden', 'modal-leave-active');
            modal.classList.add('modal-enter-active');
        }

        function closeNewsModal() {
            const modal = document.getElementById('add-news-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        
        async function handleSaveNews(event) {
            event.preventDefault();
            const form = event.target;
            const id = form.querySelector('#news-edit-id').value;
            const action = id ? 'update' : 'create';
            
            const body = JSON.stringify({
                action: action,
                id: id ? parseInt(id) : null,
                titulo: form.querySelector('#news-titulo').value,
                extracto: form.querySelector('#news-extracto').value,
                contenido_html: form.querySelector('#news-contenido-html').value,
                imagen_url: form.querySelector('#news-imagen-url').value,
                categoria: form.querySelector('#news-categoria').value,
            });

            try {
                const response = await fetch(`${API_BASE_URL}noticias_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`Noticia ${action === 'create' ? 'creada' : 'actualizada'} con éxito!`);
                    closeNewsModal();
                    renderNoticias(); 
                    renderDashboard();
                } else {
                    alert('Error al guardar la noticia: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function editNews(id) {
            const newsToEdit = window.noticiasData.find(n => parseInt(n.id) === id);
            if (newsToEdit) {
                openNewsModal(newsToEdit);
            } else {
                alert('Error: Noticia no encontrada.');
            }
        }

        async function deleteNews(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta noticia?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}noticias_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Noticia eliminada con éxito!');
                    renderNoticias();
                    renderDashboard();
                } else {
                    alert('Error al eliminar la noticia: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión o servidor.');
            }
        }

        function openReportModal(reportData = null) {
            const form = document.getElementById('add-report-form');
            form.reset();
            const permissionsContainer = document.getElementById('report-permissions');
            permissionsContainer.innerHTML = USER_PROFILES.map(profile => `
                <label class="flex items-center">
                    <input type="checkbox" name="profiles" value="${profile}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="ml-2 text-gray-700 capitalize">${profile.replace(/_/g, ' ')}</span>
                </label>
            `).join('');
            
            if (reportData) {
                document.getElementById('report-modal-title').innerText = 'Editar Reporte';
                document.getElementById('report-edit-id').value = reportData.id;
                document.getElementById('report-nombre').value = reportData.nombre;
                document.getElementById('report-url').value = reportData.url;
                document.getElementById('report-descripcion').value = reportData.descripcion;
                document.getElementById('report-categoria').value = reportData.categoria;
                const allowed = JSON.parse(reportData.allowed_profiles);
                allowed.forEach(profile => {
                    const checkbox = permissionsContainer.querySelector(`input[value="${profile}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else {
                document.getElementById('report-modal-title').innerText = 'Agregar Nuevo Reporte';
                document.getElementById('report-edit-id').value = ''; 
            }

            const modal = document.getElementById('add-report-modal');
            modal.classList.remove('hidden', 'modal-leave-active');
            modal.classList.add('modal-enter-active');
        }

        function closeReportModal() {
            const modal = document.getElementById('add-report-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-leave-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleSaveReport(event) {
            event.preventDefault();
            const form = event.target;
            const id = form.querySelector('#report-edit-id').value;
            const action = id ? 'update' : 'create';
            const selectedProfiles = Array.from(form.querySelectorAll('input[name="profiles"]:checked')).map(cb => cb.value);

            const body = {
                action: action,
                id: id ? parseInt(id) : null,
                nombre: form.querySelector('#report-nombre').value,
                url: form.querySelector('#report-url').value,
                descripcion: form.querySelector('#report-descripcion').value,
                categoria: form.querySelector('#report-categoria').value,
                allowed_profiles: selectedProfiles
            };

            try {
                const response = await fetch(`${API_BASE_URL}reportes_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(`Reporte ${action === 'create' ? 'creado' : 'actualizado'} con éxito.`);
                    closeReportModal();
                    renderReportes();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión al guardar el reporte.');
            }
        }

        function editReport(id) {
            const reportToEdit = window.allReportsData.find(r => r.id == id);
            if (reportToEdit) {
                openReportModal(reportToEdit);
            } else {
                alert('Error: Reporte no encontrado.');
            }
        }

        async function deleteReport(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este reporte?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}reportes_handler.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Reporte eliminado.');
                    renderReportes();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error de conexión al eliminar el reporte.');
            }
        }


        function changeSlide(direction) {
            const slides = document.querySelectorAll('.carousel-item');
            if (slides.length === 0) return;
            slides[window.currentSlideIndex].classList.remove('opacity-100');
            slides[window.currentSlideIndex].classList.add('opacity-0');
            window.currentSlideIndex = (window.currentSlideIndex + direction + window.totalSlides) % window.totalSlides;
            slides[window.currentSlideIndex].classList.remove('opacity-0');
            slides[window.currentSlideIndex].classList.add('opacity-100');
        }

        function navigateAndResetInterval(direction) {
            changeSlide(direction);
            if (window.carouselInterval) {
                clearInterval(window.carouselInterval);
            }
            if (window.totalSlides > 1) {
                window.carouselInterval = setInterval(() => {
                    changeSlide(1);
                }, 10000);
            }
        }


        async function loadModule(moduleName, params = []) {
            if (!await checkSession()) return;
            const [baseModule, action] = moduleName.split('/');

            if (baseModule === 'reportes' && action === 'view') {
                const id = params[0];
                renderReportViewer(id);
            } else if (baseModule === 'noticias' && action === 'detalle') {
                const id = params[0];
                await renderNoticias(id);
            } else if (baseModule === 'dashboard') {
                await renderDashboard();
            } else if (baseModule === 'slideshow-manager') {
                await renderSlideshowManager();
            } else if (baseModule === 'directorio') {
                await renderDirectorio();
            } else if (baseModule === 'noticias') {
                await renderNoticias();
            } else if (baseModule === 'cultura') {
                await renderCultura();
            } else if (baseModule === 'reportes') {
                await renderReportes();
            } else if (baseModule === 'perfil') {
                await renderProfile();
            }
            else {
                mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-sm"><h2 class="text-2xl font-bold mb-4 capitalize text-gray-800">${baseModule.replace(/-/g, ' ')}</h2><p class="text-gray-600">El contenido del módulo '${baseModule}' se cargará aquí...</p></div>`;
            }
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('mobile-menu-open-icon').classList.remove('hidden');
            document.getElementById('mobile-menu-close-icon').classList.add('hidden');
        }

        function setActiveLink(moduleName) {
            document.querySelectorAll('nav .nav-link, nav .nav-link-parent').forEach(l => {
                l.classList.remove('border-[#0b4d9a]', 'text-gray-900', 'font-semibold');
                l.classList.add('border-transparent', 'text-[#87898d]');
            });
             document.querySelectorAll('#mobile-menu .nav-link').forEach(l => {
                 l.classList.remove('bg-blue-50', 'border-[#0b4d9a]', 'text-[#0b4d9a]');
                 l.classList.add('border-transparent', 'text-gray-600');
             });

            const baseModule = moduleName.split('/')[0];

            const activeLink = document.querySelector(`.nav-link[href="#${baseModule}"]`);
            if (activeLink) {
                const parentNav = activeLink.closest('nav');
                if (parentNav) {
                    activeLink.classList.add('border-[#0b4d9a]', 'text-gray-900', 'font-semibold');
                    activeLink.classList.remove('border-transparent', 'text-[#87898d]');
                }
                const parentDropdown = activeLink.closest('.hidden.absolute');
                if (parentDropdown) {
                    const menuId = parentDropdown.id;
                    const button = document.querySelector(`button[onclick="toggleMenu('${menuId}')"]`);
                    button?.classList.add('text-gray-900', 'font-semibold');
                }
                 const mobileLink = document.querySelector(`#mobile-menu .nav-link[href="#${baseModule}"]`);
                    if(mobileLink){
                        mobileLink.classList.add('bg-blue-50', 'border-[#0b4d9a]', 'text-[#0b4d9a]');
                        mobileLink.classList.remove('border-transparent', 'text-gray-600');
                    }
            }
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = e.currentTarget.getAttribute('href');
                window.location.hash = hash;
                ['nosotros-menu', 'herramientas-menu', 'user-menu'].forEach(id => {
                    document.getElementById(id)?.classList.add('hidden');
                });
            });
        });

        async function handleHashChange() {
            if (window.carouselInterval) {
                clearInterval(window.carouselInterval);
                window.carouselInterval = null;
            }
            const hash = window.location.hash.substring(1) || 'dashboard';
            const parts = hash.split('/');
            const module = parts[0];
            const action = parts[1];
            const params = parts.slice(2);
            
            await loadModule(module + (action ? `/${action}` : ''), params);
            setActiveLink(module);
        }

        window.addEventListener('hashchange', handleHashChange);
        
        document.addEventListener('DOMContentLoaded', handleHashChange);

        const mockEventsData = [
            { date: '24 Oct', name: 'Reunión General Trimestral' },
            { date: '28 Oct', name: 'Cumpleaños de Ana Sofía' },
            { date: '02 Nov', name: 'Día de Muertos (No Laboral)' },
        ];
    </script>
</body>
</html>




